<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Biicla Jump: Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="manifest" href="/manifest.json">
    <style>
         :root { --red: #ff1a1a; --bg-card: rgba(255, 255, 255, 0.98); --gray: #f2f2f7; }
        body { 
            margin: 0; 
            padding: 0; 
            background: #111; 
            overflow: hidden; 
            touch-action: none; 
            overscroll-behavior: none; 
            font-family: -apple-system, system-ui, sans-serif; 
            user-select: none; 
            -webkit-user-select: none; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            width: 100vw; 
            padding-top: env(safe-area-inset-top, 0px); 
            padding-bottom: env(safe-area-inset-bottom, 0px); 
        }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #fff; overflow: hidden; box-shadow: 0 0 100px rgba(0,0,0,0.5); touch-action: none; overscroll-behavior: none; }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; -webkit-touch-callout: none; }

        /* UI OVERLAY */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 100; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        .bottom-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-radius: 30px 30px 0 0; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); padding: 20px; box-sizing: border-box; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: auto; }
        .bottom-sheet.open { transform: translateY(0); }
        .handle { width: 40px; height: 5px; background: #ddd; border-radius: 3px; margin: 0 auto 20px; }
        
        .content-section { display: block; }

        .ui-item { display: flex; align-items: center; justify-content: space-between; background: var(--gray); padding: 14px; border-radius: 18px; margin-bottom: 10px; }
        .ui-info { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .icon { width: 32px; height: 32px; background: var(--red); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }

        .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--red); }
        input:checked + .slider:before { transform: translateX(20px); }

        .btn-main { width: 100%; background: var(--red); color: white; border: none; padding: 18px; border-radius: 20px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px; }
        .settings-btn { position: absolute; bottom: 20px; right: 20px; width: 50px; height: 50px; background: rgba(255,255,255,0.9); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; z-index: 50; }
        .rating-btn { position: absolute; bottom: 20px; left: 20px; width: 50px; height: 50px; background: rgba(255,255,255,0.9); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; z-index: 50; }
        
        .leader-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; }
        .leader-row.me { color: var(--red); font-weight: 800; }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ —ç–∫—Ä–∞–Ω–∞ */
        @media screen and (max-width: 768px) {
            .settings-btn, .rating-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
                bottom: 15px;
            }
            
            .btn-main {
                padding: 16px;
                font-size: 16px;
            }
            
            .ui-item {
                padding: 12px;
                margin-bottom: 8px;
            }
            
            .bottom-sheet {
                padding: 15px;
            }
        }
        
        @media screen and (max-width: 480px) {
            .settings-btn, .rating-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
                bottom: 10px;
            }
            
            .btn-main {
                padding: 14px;
                font-size: 15px;
            }
            
            .ui-item {
                padding: 10px;
            }
            
            .icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
        }
        
        /* –î–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ (–ü–ö) */
        @media screen and (min-width: 1024px) {
            #game-container {
                max-width: 800px;
                max-height: 600px;
                box-shadow: 0 0 20px rgba(0,0,0,0.3);
                border-radius: 10px;
            }
            
            .settings-btn, .rating-btn {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
            
            .btn-main {
                padding: 20px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="c"></canvas>
    <button class="settings-btn" id="open-ui">‚öôÔ∏è</button>
    <button class="rating-btn" id="open-leader">üèÜ</button>

    <div class="overlay" id="ui-overlay">
        <div class="bottom-sheet" id="ui-sheet">
            <div class="handle"></div>
            <div id="tab-settings" class="content-section">
                <div class="ui-item">
                    <div class="ui-info"><div class="icon">üîä</div>–ú—É–∑—ã–∫–∞</div>
                    <label class="switch"><input type="checkbox" id="set-music" checked><span class="slider"></span></label>
                </div>
                <div class="ui-item">
                    <div class="ui-info"><div class="icon">üéöÔ∏è</div>–ì—Ä–æ–º–∫–æ—Å—Ç—å</div>
                    <input type="range" id="set-volume" min="0" max="1" step="0.01" value="1" style="width:140px;">
                </div>
                <div class="ui-item">
                    <div class="ui-info"><div class="icon">üì≥</div>–í–∏–±—Ä–æ</div>
                    <label class="switch"><input type="checkbox" id="set-vibro" checked><span class="slider"></span></label>
                </div>
            </div>
            <button class="btn-main" id="close-ui">–ì–û–¢–û–í–û</button>
        </div>
    </div>
    <div class="overlay" id="leader-overlay">
        <div class="bottom-sheet" id="leader-sheet">
            <div class="handle"></div>
            <div id="leaderboard-content"></div>
            <button class="btn-main" id="close-leader">–ì–û–¢–û–í–û</button>
        </div>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏ Telegram Web App
if (!tg.initData) {
    // –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#111;color:white;font-family:sans-serif;"><p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram</p></div>';
    throw new Error('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤ Telegram Web App');
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤–Ω—É—Ç—Ä–∏ Telegram Web App
if (!window.Telegram?.WebApp?.initData) {
    document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#111;color:white;font-family:sans-serif;"><p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram</p></div>';
    throw new Error('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤ Telegram Web App');
}

tg.ready?.();
try {
    tg.requestFullscreen?.();
    tg.lockOrientation?.();
    tg.addToHomeScreen?.();
} catch (e) {}

tg.expand();
tg.disableVerticalSwipes?.();
// tg.enableClosingConfirmation?.(); // –û—Ç–∫–ª—é—á–µ–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–ª–æ—Å—å —Å—Ä–∞–∑—É
tg.setHeaderColor?.('bg_color');

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
tg.onEvent?.('back_button_pressed', () => {
    tg.close?.();
});

// –¢–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ Esc –≤ –±—Ä–∞—É–∑–µ—Ä–µ
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        tg.close?.();
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
window.addEventListener('orientationchange', () => {
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
    setTimeout(resize, 100);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', () => {
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    setTimeout(resize, 50);
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
if (tg.viewportStableHeight) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –≤—å—é–ø–æ—Ä—Ç–∞ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    tg.onEvent?.('viewportChanged', () => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—å—é–ø–æ—Ä—Ç–∞
        setTimeout(resize, 100);
    });
}

const c = document.getElementById('c'), ctx = c.getContext('2d');
let W = 0, H = 0;
// –ë–∞–∑–æ–≤—ã–µ –∏–≥—Ä–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
let baseGravity = 0.55, baseJumpPower = -14, baseSpringPower = -28, baseRocketPower = -22;

// –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
let gravity = baseGravity, jumpPower = baseJumpPower, springPower = baseSpringPower, rocketPower = baseRocketPower;

let state = "MENU", score = 0, high = localStorage.getItem('biicla_high') || 0, charIdx = 0;
let settings = JSON.parse(localStorage.getItem('biicla_settings')) || { music: true, vibration: true, volume: 1 };
if(typeof settings.volume !== 'number') settings.volume = 1;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∏–≥—Ä–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
function adaptGameParameters() {
    // –ë–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    const baseScreenWidth = 400;
    
    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    const scale = Math.max(W / baseScreenWidth, 0.8); // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± 0.8
    
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    gravity = baseGravity;
    jumpPower = baseJumpPower * scale;
    springPower = baseSpringPower * scale;
    rocketPower = baseRocketPower * scale;
}

const imgs = {}, files = ["liza.webp", "nika.webp", "tvorch.webp", "egor.webp", "bg.jpg", "burn.webp", "igla.webp", "hot.webp"];
let loadedCount = 0;
files.forEach(f => {
    let i = new Image(); i.src = f;
    i.onload = () => loadedCount++;
    imgs[f] = i;
});

const audio = { menu: new Audio('menu.mp3'), game: new Audio('game.mp3') };
audio.menu.loop = audio.game.loop = true;
function volScale(v){ return Math.pow(v, 2); }
audio.menu.volume = audio.game.volume = volScale(settings.volume);
audio.menu.muted = audio.game.muted = (settings.volume === 0 || !settings.music);

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
let initialVolume = settings.volume;
let volumeAdjustmentActive = false;

// UI LOGIC

function updateLeaderboardUI() {
    const container = document.getElementById('leaderboard-content');
    const mock = [{name: "Biicla", s: 15400}, {name: "Egor", s: 12100}, {name: tg.initDataUnsafe?.user?.first_name || "–¢—ã", s: high, isMe: true}].sort((a,b) => b.s - a.s);
    container.innerHTML = mock.map((p, i) => `<div class="leader-row ${p.isMe?'me':''}"><span>${i+1}. ${p.name}</span><span>${p.s}</span></div>`).join('');
}

const overlay = document.getElementById('ui-overlay'), sheet = document.getElementById('ui-sheet');
const leaderOverlay = document.getElementById('leader-overlay'), leaderSheet = document.getElementById('leader-sheet');
document.getElementById('open-ui').onclick = () => { 
    overlay.classList.add('active'); 
    document.getElementById('set-volume').value = settings.volume;
    document.getElementById('set-music').checked = settings.music;
    document.getElementById('set-vibro').checked = settings.vibration;
    setTimeout(() => sheet.classList.add('open'), 10); 
};
document.getElementById('open-leader').onclick = () => { 
    updateLeaderboardUI();
    leaderOverlay.classList.add('active'); 
    setTimeout(() => leaderSheet.classList.add('open'), 10); 
};
document.getElementById('close-ui').onclick = () => {
    sheet.classList.remove('open'); setTimeout(() => overlay.classList.remove('active'), 300);
    settings.music = document.getElementById('set-music').checked;
    settings.vibration = document.getElementById('set-vibro').checked;
    settings.volume = parseFloat(document.getElementById('set-volume').value || '1');
    localStorage.setItem('biicla_settings', JSON.stringify(settings));
    if(!settings.music) { audio.menu.pause(); audio.game.pause(); audio.menu.muted = audio.game.muted = true; } 
    else { 
        audio.menu.volume = audio.game.volume = volScale(settings.volume); 
        audio.menu.muted = audio.game.muted = (settings.volume === 0); 
        if(state === "MENU") audio.menu.play().catch(()=>{}); 
    }
};
document.getElementById('close-leader').onclick = () => {
    leaderSheet.classList.remove('open'); setTimeout(() => leaderOverlay.classList.remove('active'), 300);
};
document.getElementById('set-volume').addEventListener('input', (e) => {
    const v = parseFloat(e.target.value || '1');
    settings.volume = v;
    audio.menu.volume = audio.game.volume = volScale(v);
    audio.menu.muted = audio.game.muted = (v === 0 || !settings.music);
    try { localStorage.setItem('biicla_settings', JSON.stringify(settings)); } catch {}
});

// GAME ENGINE
let plats = [], bullets = [], enemies = [], boosters = [], particles = [];
const p = { x: 0, y: 0, vx: 0, vy: 0, ang: 0, rocket: 0, dir: 1 };
let input = { currX: 0, startX: 0 };

function resize() {
    const rect = document.getElementById('game-container').getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤—å—é–ø–æ—Ä—Ç–∞ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
    if (tg.viewportStableHeight && tg.viewportStableWidth) {
        W = Math.round(tg.viewportStableWidth);
        H = Math.round(tg.viewportStableHeight);
    } else {
        W = Math.round(rect.width); 
        H = Math.round(rect.height);
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö
    W = Math.max(W, 320);
    H = Math.max(H, 480);
    
    c.width = Math.round(W * dpr); 
    c.height = Math.round(H * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    if(state !== "PLAYING") { 
        input.currX = W/2; 
        p.x = W/2; 
        p.y = H-150; 
    }
    
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
    adjustUIElements();
    
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∏–≥—Ä–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥ –Ω–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
    adaptGameParameters();
}
// –ó–∞–º–µ–Ω–∏–º –≤—ã–∑–æ–≤ –Ω–∞ –Ω–∞—à—É —É–ª—É—á—à–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
tg.onEvent?.('viewportChanged', () => {
    setTimeout(resize, 100);
});
resize();

// –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∏–≥—Ä–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
adaptGameParameters();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
function adjustUIElements() {
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
    const settingsBtn = document.querySelector('.settings-btn');
    const ratingBtn = document.querySelector('.rating-btn');
    
    if (W <= 480) {
        // –î–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤
        if (settingsBtn) {
            settingsBtn.style.width = '40px';
            settingsBtn.style.height = '40px';
            settingsBtn.style.fontSize = '18px';
            settingsBtn.style.bottom = '10px';
            settingsBtn.style.right = '10px';
        }
        if (ratingBtn) {
            ratingBtn.style.width = '40px';
            ratingBtn.style.height = '40px';
            ratingBtn.style.fontSize = '18px';
            ratingBtn.style.bottom = '10px';
            ratingBtn.style.left = '10px';
        }
    } else if (W <= 768) {
        // –î–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤
        if (settingsBtn) {
            settingsBtn.style.width = '45px';
            settingsBtn.style.height = '45px';
            settingsBtn.style.fontSize = '20px';
            settingsBtn.style.bottom = '15px';
            settingsBtn.style.right = '15px';
        }
        if (ratingBtn) {
            ratingBtn.style.width = '45px';
            ratingBtn.style.height = '45px';
            ratingBtn.style.fontSize = '20px';
            ratingBtn.style.bottom = '15px';
            ratingBtn.style.left = '15px';
        }
    } else {
        // –î–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤
        if (settingsBtn) {
            settingsBtn.style.width = '50px';
            settingsBtn.style.height = '50px';
            settingsBtn.style.fontSize = '24px';
            settingsBtn.style.bottom = '20px';
            settingsBtn.style.right = '20px';
        }
        if (ratingBtn) {
            ratingBtn.style.width = '50px';
            ratingBtn.style.height = '50px';
            ratingBtn.style.fontSize = '24px';
            ratingBtn.style.bottom = '20px';
            ratingBtn.style.left = '20px';
        }
    }
}

function spawn(y) {
    let r = Math.random(), type = r > 0.9 ? 2 : (r > 0.8 ? 1 : 0);
    
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º –ø–æ–¥ —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞
    const platformWidth = Math.min(75, W * 0.2); // –ú–∞–∫—Å–∏–º—É–º 20% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
    const platformMinX = 10;
    const platformMaxX = W - platformMinX - platformWidth;
    const platformX = Math.random() * (platformMaxX - platformMinX) + platformMinX;
    
    let pl = { 
        x: platformX, 
        y: y, 
        w: platformWidth, 
        h: 18, 
        type: type, 
        active: true, 
        sp: 2, 
        scored: false 
    };
    
    if(type === 0) {
        if(Math.random() > 0.93) pl.spring = true;
        else if(Math.random() > 0.97) {
            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –±—É—Å—Ç–µ—Ä–∞ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
            boosters.push({ x: pl.x + pl.w/2, y: y-25 });
        }
    }
    plats.push(pl);
    
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤—Ä–∞–≥–æ–≤ –ø–æ–¥ —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞
    const enemySize = Math.min(40, W * 0.1); // –†–∞–∑–º–µ—Ä –≤—Ä–∞–≥–∞ –Ω–µ –±–æ–ª—å—à–µ 10% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
    const enemyMinX = enemySize/2;
    const enemyMaxX = W - enemySize/2;
    const enemyX = Math.random() * (enemyMaxX - enemyMinX) + enemyMinX;
    
    if(Math.random() > 0.97) {
        enemies.push({ 
            x: enemyX, 
            y: y-50, 
            t: Math.random()*5, 
            ang: 0, 
            angVel: 0 
        });
    }
}

function reset() {
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
    p.x = W/2; 
    p.y = H - Math.min(150, H * 0.2); // –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞ –Ω–µ –±–ª–∏–∂–µ —á–µ–º 20% –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è
    p.vx = 0; 
    p.vy = 0; 
    p.rocket = 0;
    
    score = 0; 
    plats = []; 
    enemies = []; 
    bullets = []; 
    boosters = []; 
    particles = [];
    
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    const platformWidth = Math.min(100, W * 0.25); // –ú–∞–∫—Å–∏–º—É–º 25% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
    const platformX = W/2 - platformWidth/2;
    const platformY = H - Math.min(50, H * 0.1); // –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–µ –≤—ã—à–µ 10% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
    
    plats.push({
        x: platformX, 
        y: platformY, 
        w: platformWidth, 
        h: 20, 
        type: 0, 
        active: true, 
        scored: true
    });
    
    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
    const platformSpacing = Math.min(75, H * 0.15); // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –±–æ–ª—å—à–µ 15% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
    
    for(let i=1; i<12; i++) {
        spawn(H - i * platformSpacing);
    }
}

function switchTrack(to) {
    if(!settings.music) return;
    if(to === 'game') { 
        audio.menu.pause(); 
        audio.game.currentTime = 0; 
        audio.game.play().catch(()=>{}); 
        
        // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∏–≥—Ä–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
        document.getElementById('open-ui').style.display = 'none';
        document.getElementById('open-leader').style.display = 'none';
    }
    else if(to === 'menu') { 
        audio.game.pause(); 
        audio.menu.currentTime = 0; 
        audio.menu.play().catch(()=>{}); 
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –º–µ–Ω—é
        document.getElementById('open-ui').style.display = 'flex';
        document.getElementById('open-leader').style.display = 'flex';
    }
    else { 
        audio.menu.pause(); 
        audio.game.pause(); 
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
        document.getElementById('open-ui').style.display = 'flex';
        document.getElementById('open-leader').style.display = 'flex';
    }
}

c.onpointerdown = e => {
    e.preventDefault();
    if(overlay.classList.contains('active')) return;
    const rect = c.getBoundingClientRect();
    input.startX = ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) / rect.width * W;
    input.currX = input.startX;
    const touchY = ((e.touches ? e.touches[0].clientY : e.clientY) - rect.top) / rect.height * H;
    c.setPointerCapture?.(e.pointerId);

    if(state === "MENU") {
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç—å –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ò–ì–†–ê–¢–¨" –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        // –ö–Ω–æ–ø–∫–∞ "–ò–ì–†–ê–¢–¨" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞
        const playButtonAreaTop = H - Math.min(120, H * 0.15); // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –∫–Ω–æ–ø–∫–∏
        
        if(touchY > playButtonAreaTop) {
            state = "PLAYING"; reset(); switchTrack('game');
            document.documentElement.requestFullscreen?.();

            // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∏–≥—Ä–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
            document.getElementById('open-ui').style.display = 'none';
            document.getElementById('open-leader').style.display = 'none';
        }
    } else if (state === "PLAYING") {
        // –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫—É –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –≤ –∏–≥—Ä–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
        initialVolume = settings.volume;
        volumeAdjustmentActive = true;
        if(p.rocket <= 0) bullets.push({ x: p.x, y: p.y - 40 });
    } else if (state === "GAMEOVER") {
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –æ–±–ª–∞—Å—Ç–∏ –Ω–∞–∂–∞—Ç–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const retryButtonTop = H/2 - Math.min(55, H * 0.07)/2; // –¶–µ–Ω—Ç—Ä –∫–Ω–æ–ø–∫–∏ "–ï–©–ï –†–ê–ó"
        const retryButtonBottom = H/2 + Math.min(55, H * 0.07)/2;
        const menuButtonTop = H/2 + Math.min(55, H * 0.07)/2 + Math.min(65, H * 0.08); // –í–µ—Ä—Ö –∫–Ω–æ–ø–∫–∏ "–í –ú–ï–ù–Æ"
        
        if(touchY > retryButtonTop && touchY < retryButtonBottom) { 
            state = "PLAYING"; reset(); switchTrack('game'); 
        }
        else if(touchY > menuButtonTop) { 
            state = "MENU"; switchTrack('menu'); 
        }
    }
};

window.onpointermove = e => {
    e.preventDefault();
    const rect = c.getBoundingClientRect();
    input.currX = ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) / rect.width * W;
    
    // –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –≤ –∏–≥—Ä–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
    if(state === "PLAYING" && volumeAdjustmentActive) {
        const deltaX = input.currX - input.startX;
        // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏: –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ - —Ç–∏—à–µ, –≤–ø—Ä–∞–≤–æ - –≥—Ä–æ–º—á–µ
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–æ–≤–∏–Ω—É —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞ –∫–∞–∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        const volumeChange = (deltaX / (W / 2)) * 0.5; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ¬±50%
        let newVolume = initialVolume + volumeChange;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –æ—Ç 0 –¥–æ 1
        newVolume = Math.max(0, Math.min(1, newVolume));

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—É—é –≥—Ä–æ–º–∫–æ—Å—Ç—å
        settings.volume = newVolume;
        audio.menu.volume = audio.game.volume = volScale(newVolume);
        audio.menu.muted = audio.game.muted = (newVolume === 0 || !settings.music);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        document.getElementById('set-volume').value = newVolume;
    }
};

window.onpointerup = e => {
    e.preventDefault();
    c.releasePointerCapture?.(e.pointerId);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏
    if(volumeAdjustmentActive) {
        volumeAdjustmentActive = false;
        try { 
            localStorage.setItem('biicla_settings', JSON.stringify(settings)); 
        } catch {}
    }
    
    if(state === "MENU") {
        const dist = input.currX - input.startX;
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Å–≤–∞–π–ø–∞ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const swipeThreshold = Math.min(60, W * 0.15); // 15% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
        if(Math.abs(dist) > swipeThreshold) {
            charIdx = (charIdx + (dist > 0 ? -1 : 1) + 4) % 4;
            if(settings.vibration) tg.HapticFeedback.selectionChanged();
        }
    }
};
window.onpointercancel = () => {
    input.currX = p.x;
    
    // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫—É –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
    if(volumeAdjustmentActive) {
        volumeAdjustmentActive = false;
        try { 
            localStorage.setItem('biicla_settings', JSON.stringify(settings)); 
        } catch {}
    }
};

function loop() {
    requestAnimationFrame(loop);
    if(loadedCount < 8) return;
    ctx.drawImage(imgs["bg.jpg"], 0, 0, W, H);

    if(state === "PLAYING") {
        if(!tg.isExpanded) tg.expand();
        let diff = 1 + (score / 3000);
        let speedKmh = 40 + (score / 70) * 0.25;
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const controlSensitivity = 0.2 * (W / 400); // –ë–∞–∑–æ–≤–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —à–∏—Ä–∏–Ω—ã 400px
        let targetVX = (input.currX - p.x) * controlSensitivity;
        p.vx += (targetVX - p.vx) * 0.25; p.x += p.vx;
        if(p.vx > 0.5) p.dir = 1; else if(p.vx < -0.5) p.dir = -1;
        if(p.x > W) p.x = 0; else if(p.x < 0) p.x = W;

        if(p.rocket > 0) { p.vy = rocketPower; p.rocket--; p.ang += 0.4; } 
        else { p.vy += gravity * diff; p.ang *= 0.92; p.ang += (p.vx * 0.04 - p.ang) * 0.12; }
        p.y += p.vy;

        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫—É, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–π –∫–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
        const cameraThreshold = H * 0.45;
        let shift = 0; 
        if(p.y < cameraThreshold) { 
            shift = cameraThreshold - p.y; 
            p.y = cameraThreshold; 
        }

        plats.forEach(pl => {
            pl.y += shift;
            if(pl.type === 1) { 
                pl.x += pl.sp; 
                if(pl.x < 0 || pl.x > W-pl.w) pl.sp *= -1; 
            }
            if(!pl.scored && p.y < pl.y) { 
                score += 10; 
                pl.scored = true; 
            }
            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∫–æ–ª–ª–∏–∑–∏–∏ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
            const collisionOffsetX = Math.min(20, W * 0.05); // 5% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞, –Ω–æ –Ω–µ –º–µ–Ω–µ–µ 20px
            const collisionOffsetY = Math.min(40, H * 0.08); // 8% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞, –Ω–æ –Ω–µ –º–µ–Ω–µ–µ 40px
            
            if(p.vy > 0 && pl.active && 
               p.x + collisionOffsetX > pl.x && 
               p.x - collisionOffsetX < pl.x + pl.w && 
               p.y + collisionOffsetY > pl.y && 
               p.y + collisionOffsetY < pl.y + pl.h) {
                p.vy = pl.spring ? springPower : jumpPower;
                if(pl.type === 2) pl.active = false;
                if(settings.vibration) tg.HapticFeedback.impactOccurred('medium');
            }
        });

        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–¥–∏—É—Å —Å–±–æ—Ä–∞ –±—É—Å—Ç–µ—Ä–æ–≤ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const boosterRadius = Math.min(35, Math.max(20, W * 0.08)); // 8% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
        boosters.forEach((b, i) => { 
            b.y += shift; 
            if(Math.hypot(p.x - b.x, p.y - b.y) < boosterRadius) { 
                p.rocket = 70; 
                boosters.splice(i, 1); 
            }
        });
        
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const bulletSpeed = Math.min(14, Math.max(8, W * 0.035)); // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —à–∏—Ä–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞
        bullets.forEach((b, i) => { 
            b.y -= bulletSpeed; 
            if(b.y < -50) bullets.splice(i, 1); 
        });
        
        enemies.forEach((e, i) => {
            e.y += shift; 
            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∞–º–ø–ª–∏—Ç—É–¥—É –¥–≤–∏–∂–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
            const driftAmplitude = Math.min(45, W * 0.1); // 10% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
            let drift = Math.sin(Date.now()*0.003 + e.t) * driftAmplitude;
            e.angVel += (Math.random() - 0.5) * 0.02;
            e.angVel *= 0.95;
            e.ang += e.angVel;
            
            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–¥–∏—É—Å —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –≤—Ä–∞–≥–æ–º
            const enemyCollisionRadius = Math.min(35, Math.max(20, W * 0.08)); // 8% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
            if(p.rocket <= 0 && Math.hypot(p.x - (e.x + drift), p.y - e.y) < enemyCollisionRadius) {
                state = "GAMEOVER";
                switchTrack('stop');
                if(settings.vibration) tg.HapticFeedback.impactOccurred('heavy');
            }
            
            bullets.forEach((bu, bi) => {
                // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–¥–∏—É—Å —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è –ø—É–ª–∏ —Å –≤—Ä–∞–≥–æ–º
                const bulletHitRadius = Math.min(40, Math.max(25, W * 0.1)); // 10% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
                if(Math.hypot(bu.x - (e.x + drift), bu.y - e.y) < bulletHitRadius) {
                    // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
                    const particleCount = Math.min(12, Math.max(6, Math.floor(W * 0.015)));
                    for(let j=0; j<particleCount; j++) {
                        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∞—Å—Ç–∏—Ü
                        const particleSpeed = Math.min(6, Math.max(3, W * 0.007));
                        particles.push({ 
                            x: e.x + drift, 
                            y: e.y, 
                            vx: (Math.random()-0.5)*particleSpeed, 
                            vy: (Math.random()-0.5)*particleSpeed-2, 
                            life: 30 
                        });
                    }
                    enemies.splice(i, 1); 
                    bullets.splice(bi, 1); 
                    score += 100;
                    if(settings.vibration) tg.HapticFeedback.impactOccurred('heavy');
                }
            });
        });

        if(score > high) { 
            high = score; 
            localStorage.setItem('biicla_high', high); 
        }
        
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const platformThreshold = Math.min(15, Math.max(10, Math.floor(H * 0.025))); // –ü—Ä–∏–º–µ—Ä–Ω–æ 2.5% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
        while(plats.length < platformThreshold) {
            // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –Ω–æ–≤—ã–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
            const spacing = Math.min(80, H * 0.15); // 15% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
            spawn(Math.min(...plats.map(o=>o.y)) - spacing);
        }
        
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –≥—Ä–∞–Ω–∏—Ü—É –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º
        const platformRemoveThreshold = Math.min(100, H * 0.2); // 20% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
        plats = plats.filter(pl => pl.y < H + platformRemoveThreshold);
        
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –≥—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–∏–≥—Ä—ã—à–∞
        const gameOverThreshold = Math.min(100, H * 0.2); // 20% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
        if(p.y > H + gameOverThreshold) { 
            state = "GAMEOVER"; 
            switchTrack('stop'); 
        }

        // DRAW
        plats.forEach(pl => {
            if(!pl.active) return;
            ctx.fillStyle = pl.type === 1 ? "#FFD700" : (pl.type === 2 ? "#ff1a1a" : "#fff");
            ctx.beginPath(); ctx.roundRect(pl.x, pl.y, pl.w, pl.h, 8); ctx.fill();
            ctx.strokeStyle = "#000"; ctx.lineWidth = 2; ctx.stroke();
            if(pl.spring) { ctx.fillStyle="#000"; ctx.fillRect(pl.x+pl.w/2-8, pl.y-6, 16, 6); }
        });
        boosters.forEach(b => { 
            ctx.save(); ctx.translate(b.x, b.y); ctx.rotate(Math.sin(Date.now()*0.01)*0.2);
            let img = imgs["burn.webp"], w = 20, h = w * (img.height/img.width);
            ctx.drawImage(img, -w/2, -h/2, w, h); ctx.restore();
        });
        enemies.forEach(e => { let d = Math.sin(Date.now()*0.003 + e.t)*45; 
            ctx.save();
            ctx.translate(e.x + d, e.y);
            ctx.rotate(e.ang);
            let img = imgs["hot.webp"], w = 35, h = w * (img.height/img.width);
            ctx.drawImage(img, -w/2, -h/2, w, h);
            ctx.restore();
        });
        bullets.forEach(b => {
            let img = imgs["igla.webp"], w = 25, h = w * (img.height/img.width);
            ctx.drawImage(img, b.x-w/2, b.y-h/2, w, h);
        });
        
        particles.forEach((pr, i) => {
            pr.x += pr.vx; pr.y += pr.vy; pr.vy += 0.2; pr.life--;
            ctx.fillStyle = `rgba(255, 100, 50, ${pr.life/30})`; 
            ctx.beginPath(); ctx.arc(pr.x, pr.y, 3, 0, Math.PI*2); ctx.fill();
            if(pr.life <= 0) particles.splice(i, 1);
        });
        
        let charImg = imgs[files[charIdx]], cw = 30, ch = cw * (charImg.height/charImg.width);
        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.ang); if(p.dir === -1) ctx.scale(-1, 1);
        ctx.drawImage(charImg, -cw/2, -ch/2, cw, ch); ctx.restore();

        // HUD
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã HUD –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const hudHeight = Math.min(50, H * 0.08); // –ú–∞–∫—Å–∏–º—É–º 8% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
        const hudPadding = Math.min(12, W * 0.03); // –û—Ç—Å—Ç—É–ø—ã –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã —à–∏—Ä–∏–Ω–µ
        
        ctx.fillStyle = "rgba(0,0,0,0.8)"; 
        ctx.fillRect(0, 0, W, hudHeight);
        
        ctx.strokeStyle = "#ff1a1a"; 
        ctx.lineWidth = 2; 
        ctx.strokeRect(2, 2, W-4, hudHeight-4);
        
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        const fontSize = Math.min(20, Math.max(12, W * 0.04)); // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —à–∏—Ä–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞
        const smallFontSize = Math.min(14, Math.max(10, W * 0.03));
        
        ctx.fillStyle = "#ff1a1a"; 
        ctx.font = `bold ${fontSize}px sans-serif`; 
        ctx.textAlign = "left"; 
        ctx.fillText("SCORE: " + score, hudPadding, hudHeight * 0.6);
        
        ctx.textAlign = "right"; 
        ctx.fillText("HIGH: " + high, W - hudPadding, hudHeight * 0.6);
        
        ctx.font = `${smallFontSize}px sans-serif`; 
        ctx.fillStyle = "#fff"; 
        ctx.textAlign = "center"; 
        ctx.fillText("SPEED: " + speedKmh.toFixed(1) + " –∫–º/—á", W/2, hudHeight * 0.7);
    } 
    else if(state === "MENU") {
        ctx.fillStyle = "rgba(0,0,0,0.4)"; 
        ctx.fillRect(0,0,W,H);
        
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ç–µ–∫—Å—Ç–∞ –≤ –º–µ–Ω—é
        const titleFontSize = Math.min(42, Math.max(24, W * 0.06)); // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —à–∏—Ä–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞
        const subtitleFontSize = Math.min(20, Math.max(14, W * 0.04));
        const instructionFontSize = Math.min(14, Math.max(10, W * 0.03));
        
        ctx.fillStyle = "#fff"; 
        ctx.textAlign = "center"; 
        ctx.font = `800 ${titleFontSize}px sans-serif`; 
        ctx.fillText("OTSHITIE", W/2, H * 0.15);
        
        ctx.font = `600 ${subtitleFontSize}px sans-serif`; 
        ctx.fillText("JUMP", W/2, H * 0.22);
        
        ctx.font = `${instructionFontSize}px sans-serif`; 
        ctx.fillText("–°–≤–∞–π–ø –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞", W/2, H * 0.28);

        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
        let charImg = imgs[files[charIdx]];
        const charSize = Math.min(80, Math.max(40, W * 0.15)); // 15% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
        const ch = charSize * (charImg.height/charImg.width);
        ctx.drawImage(charImg, W/2-charSize/2, H/2-ch/2 + Math.sin(Date.now()*0.002)*15, charSize, ch);

        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–∫–∏ "–ò–ì–†–ê–¢–¨"
        const buttonWidth = Math.min(200, Math.max(100, W * 0.4)); // 40% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
        const buttonHeight = Math.min(60, Math.max(30, H * 0.08)); // 8% –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞
        const buttonY = H - Math.min(120, H * 0.15); // 15% –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è
        const buttonTextY = buttonY + buttonHeight * 0.35; // 35% –≤—ã—Å–æ—Ç—ã –∫–Ω–æ–ø–∫–∏
        
        ctx.fillStyle = "#ff1a1a"; 
        ctx.beginPath(); 
        ctx.roundRect(W/2-buttonWidth/2, buttonY, buttonWidth, buttonHeight, 20); 
        ctx.fill();
        
        const playButtonFontSize = Math.min(22, Math.max(16, W * 0.05));
        ctx.fillStyle = "#fff"; 
        ctx.font = `bold ${playButtonFontSize}px sans-serif`; 
        ctx.fillText("–ò–ì–†–ê–¢–¨", W/2, buttonTextY);
    }
    else if(state === "GAMEOVER") {
        ctx.fillStyle = "rgba(0,0,0,0.85)"; 
        ctx.fillRect(0,0,W,H);
        
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ç–µ–∫—Å—Ç–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ GAMEOVER
        const failFontSize = Math.min(48, Math.max(30, W * 0.08));
        const scoreFontSize = Math.min(24, Math.max(16, W * 0.05));
        const buttonFontSize = Math.min(20, Math.max(14, W * 0.04));
        
        ctx.fillStyle = "#fff"; 
        ctx.textAlign = "center"; 
        ctx.font = `bold ${failFontSize}px sans-serif`; 
        ctx.fillText("FAIL", W/2, H/2 - H * 0.15);
        
        ctx.font = `${scoreFontSize}px sans-serif`; 
        ctx.fillText("–°–ß–ï–¢: " + score, W/2, H/2 - H * 0.08);
        
        // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–Ω–æ–ø–æ–∫
        const buttonWidth = Math.min(180, Math.max(100, W * 0.35));
        const retryButtonHeight = Math.min(55, Math.max(40, H * 0.07));
        const menuButtonHeight = Math.min(50, Math.max(35, H * 0.06));
        
        ctx.fillStyle = "#fff"; 
        ctx.beginPath(); 
        ctx.roundRect(W/2-buttonWidth/2, H/2+H*0.02, buttonWidth, retryButtonHeight, 15); 
        ctx.fill();
        
        ctx.fillStyle = "#000"; 
        ctx.font = `bold ${buttonFontSize}px sans-serif`; 
        ctx.fillText("–ï–©–ï –†–ê–ó", W/2, H/2+retryButtonHeight * 0.65);
        
        ctx.fillStyle = "rgba(255,255,255,0.2)"; 
        ctx.beginPath(); 
        ctx.roundRect(W/2-buttonWidth/2, H/2+H*0.12, buttonWidth, menuButtonHeight, 15); 
        ctx.fill();
        
        ctx.fillStyle = "#fff"; 
        ctx.fillText("–í –ú–ï–ù–Æ", W/2, H/2+H*0.12+menuButtonHeight * 0.65);
    }
}
loop();
if(settings.music) audio.menu.play().catch(()=>{});
</script>
</body>
</html>

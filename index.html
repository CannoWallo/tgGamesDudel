<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Biicla Jump: Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="manifest" href="/manifest.json">
    <style>
         :root { --red: #ff1a1a; --bg-card: rgba(255, 255, 255, 0.98); --gray: #f2f2f7; }
        body { margin: 0; padding: 0; background: #111; overflow: hidden; touch-action: none; overscroll-behavior: none; font-family: -apple-system, system-ui, sans-serif; user-select: none; -webkit-user-select: none; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #fff; overflow: hidden; box-shadow: 0 0 100px rgba(0,0,0,0.5); touch-action: none; overscroll-behavior: none; }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; -webkit-touch-callout: none; }

        /* UI OVERLAY */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 100; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        .bottom-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-radius: 30px 30px 0 0; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); padding: 20px; box-sizing: border-box; max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; touch-action: auto; }
        .bottom-sheet.open { transform: translateY(0); }
        .handle { width: 40px; height: 5px; background: #ddd; border-radius: 3px; margin: 0 auto 20px; }
        
        .content-section { display: block; }

        .ui-item { display: flex; align-items: center; justify-content: space-between; background: var(--gray); padding: 14px; border-radius: 18px; margin-bottom: 10px; }
        .ui-info { display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .icon { width: 32px; height: 32px; background: var(--red); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }

        .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--red); }
        input:checked + .slider:before { transform: translateX(20px); }

        .btn-main { width: 100%; background: var(--red); color: white; border: none; padding: 18px; border-radius: 20px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px; }
        .settings-btn { position: absolute; bottom: 20px; right: 20px; width: 50px; height: 50px; background: rgba(255,255,255,0.9); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; z-index: 50; }
        .rating-btn { position: absolute; bottom: 20px; left: 20px; width: 50px; height: 50px; background: rgba(255,255,255,0.9); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: none; z-index: 50; }
        
        .leader-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; }
        .leader-row.me { color: var(--red); font-weight: 800; }
        
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="c"></canvas>
    <button class="settings-btn" id="open-ui">‚öôÔ∏è</button>
    <button class="rating-btn" id="open-leader">üèÜ</button>

    <div class="overlay" id="ui-overlay">
        <div class="bottom-sheet" id="ui-sheet">
            <div class="handle"></div>
            <div id="tab-settings" class="content-section">
                <div class="ui-item">
                    <div class="ui-info"><div class="icon">üîä</div>–ú—É–∑—ã–∫–∞</div>
                    <label class="switch"><input type="checkbox" id="set-music" checked><span class="slider"></span></label>
                </div>
                <div class="ui-item">
                    <div class="ui-info"><div class="icon">üéöÔ∏è</div>–ì—Ä–æ–º–∫–æ—Å—Ç—å</div>
                    <input type="range" id="set-volume" min="0" max="1" step="0.01" value="1" style="width:140px;">
                </div>
                <div class="ui-item">
                    <div class="ui-info"><div class="icon">üì≥</div>–í–∏–±—Ä–æ</div>
                    <label class="switch"><input type="checkbox" id="set-vibro" checked><span class="slider"></span></label>
                </div>
            </div>
            <button class="btn-main" id="close-ui">–ì–û–¢–û–í–û</button>
        </div>
    </div>
    <div class="overlay" id="leader-overlay">
        <div class="bottom-sheet" id="leader-sheet">
            <div class="handle"></div>
            <div id="leaderboard-content"></div>
            <button class="btn-main" id="close-leader">–ì–û–¢–û–í–û</button>
        </div>
    </div>
</div>

<script>
const tg = window.Telegram.WebApp;
let isPaused = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—É–∑—ã

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏ Telegram Web App
if (!tg.initData || !window.Telegram?.WebApp?.initData) {
    // –î–ï–ë–ê–ì –†–ï–ñ–ò–ú: –ï—Å–ª–∏ –Ω–µ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º, –ø–æ–∑–≤–æ–ª—è–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞ (—É–±—Ä–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
    console.warn('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ Telegram. –í–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏.');
    // document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#111;color:white;font-family:sans-serif;"><p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram</p></div>';
    // throw new Error('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤ Telegram Web App');
} else {
    tg.ready?.();
    try {
        tg.requestFullscreen?.();
        tg.lockOrientation?.();
        tg.addToHomeScreen?.();
    } catch (e) {}

    tg.expand();
    tg.disableVerticalSwipes?.();
    tg.setHeaderColor?.('bg_color');

    tg.onEvent?.('back_button_pressed', () => tg.close?.());
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') tg.close?.(); });
    tg.onEvent?.('viewportChanged', resize);
}

const c = document.getElementById('c'), ctx = c.getContext('2d');
let W = 0, H = 0;
let gravity = 0.55, jumpPower = -14, springPower = -28, rocketPower = -22;

let state = "MENU", score = 0, high = localStorage.getItem('biicla_high') || 0, charIdx = 0;
let settings = JSON.parse(localStorage.getItem('biicla_settings')) || { music: true, vibration: true, volume: 1 };
if(typeof settings.volume !== 'number') settings.volume = 1;


const imgs = {}, files = ["liza.webp", "nika.webp", "tvorch.webp", "egor.webp", "bg.jpg", "burn.webp", "igla.webp", "hot.webp"];
let loadedCount = 0;
// –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Ñ–æ–ª–ª–±—ç–∫–æ–º
files.forEach(f => {
    let i = new Image(); 
    i.src = f;
    i.onload = () => loadedCount++;
    i.onerror = () => { 
        console.log("Image failed:", f); 
        loadedCount++; // –°—á–∏—Ç–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º, —á—Ç–æ–±—ã –∏–≥—Ä–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª–∞
    };
    imgs[f] = i;
});

const audio = { menu: new Audio('menu.mp3'), game: new Audio('game.mp3') };
audio.menu.loop = audio.game.loop = true;
function volScale(v){ return Math.pow(v, 2); }
audio.menu.volume = audio.game.volume = volScale(settings.volume);
audio.menu.muted = audio.game.muted = (settings.volume === 0 || !settings.music);

// UI LOGIC

function updateLeaderboardUI() {
    const container = document.getElementById('leaderboard-content');
    const mock = [{name: "Biicla", s: 15400}, {name: "Egor", s: 12100}, {name: tg.initDataUnsafe?.user?.first_name || "–¢—ã", s: high, isMe: true}].sort((a,b) => b.s - a.s);
    container.innerHTML = mock.map((p, i) => `<div class="leader-row ${p.isMe?'me':''}"><span>${i+1}. ${p.name}</span><span>${p.s}</span></div>`).join('');
}

// === –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—É–∑–æ–π ===
function togglePause(active) {
    if(state !== "PLAYING") return;
    isPaused = active;
    if(isPaused) {
        audio.game.pause();
    } else if(settings.music && !isPaused) {
        audio.game.play().catch(()=>{});
    }
}

const overlay = document.getElementById('ui-overlay'), sheet = document.getElementById('ui-sheet');
const leaderOverlay = document.getElementById('leader-overlay'), leaderSheet = document.getElementById('leader-sheet');

document.getElementById('open-ui').onclick = () => { 
    overlay.classList.add('active'); 
    togglePause(true); // –°—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É
    document.getElementById('set-volume').value = settings.volume;
    document.getElementById('set-music').checked = settings.music;
    document.getElementById('set-vibro').checked = settings.vibration;
    setTimeout(() => sheet.classList.add('open'), 10); 
};
document.getElementById('open-leader').onclick = () => { 
    updateLeaderboardUI();
    overlay.classList.add('active'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è
    togglePause(true); // –°—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É
    leaderOverlay.classList.add('active'); 
    setTimeout(() => leaderSheet.classList.add('open'), 10); 
};
document.getElementById('close-ui').onclick = () => {
    sheet.classList.remove('open'); setTimeout(() => overlay.classList.remove('active'), 300);
    togglePause(false); // –°–Ω–∏–º–∞–µ–º –ø–∞—É–∑—É
    settings.music = document.getElementById('set-music').checked;
    settings.vibration = document.getElementById('set-vibro').checked;
    settings.volume = parseFloat(document.getElementById('set-volume').value || '1');
    localStorage.setItem('biicla_settings', JSON.stringify(settings));
    if(!settings.music) { audio.menu.pause(); audio.game.pause(); audio.menu.muted = audio.game.muted = true; } 
    else { 
        audio.menu.volume = audio.game.volume = volScale(settings.volume); 
        audio.menu.muted = audio.game.muted = (settings.volume === 0); 
        if(state === "MENU") audio.menu.play().catch(()=>{});
        else if(state === "PLAYING" && !isPaused) audio.game.play().catch(()=>{});
    }
};
document.getElementById('close-leader').onclick = () => {
    leaderSheet.classList.remove('open'); 
    setTimeout(() => { 
        leaderOverlay.classList.remove('active'); 
        overlay.classList.remove('active'); // –£–±–∏—Ä–∞–µ–º –æ–±—â–∏–π –æ–≤–µ—Ä–ª–µ–π
        togglePause(false); // –°–Ω–∏–º–∞–µ–º –ø–∞—É–∑—É
    }, 300);
};
document.getElementById('set-volume').addEventListener('input', (e) => {
    const v = parseFloat(e.target.value || '1');
    settings.volume = v;
    audio.menu.volume = audio.game.volume = volScale(v);
    audio.menu.muted = audio.game.muted = (v === 0 || !settings.music);
    try { localStorage.setItem('biicla_settings', JSON.stringify(settings)); } catch {}
});

// GAME ENGINE
let plats = [], bullets = [], enemies = [], boosters = [], particles = [];
const p = { x: 0, y: 0, vx: 0, vy: 0, ang: 0, rocket: 0, dir: 1 };
let input = { currX: 0, startX: 0 };

function resize() {
    const rect = document.getElementById('game-container').getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    
    if (tg.viewportStableHeight && tg.viewportStableWidth) {
        W = Math.round(tg.viewportStableWidth);
        H = Math.round(tg.viewportStableHeight);
    } else {
        W = Math.round(rect.width); 
        H = Math.round(rect.height);
    }
    
    c.width = Math.round(W * dpr); 
    c.height = Math.round(H * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    if(state !== "PLAYING") { 
        input.currX = W/2; 
        p.x = W/2; 
        p.y = H-150; 
    }
}
window.addEventListener('resize', resize);
tg.onEvent?.('viewportChanged', resize);
resize();


function spawn(y) {
    let r = Math.random(), type = r > 0.9 ? 2 : (r > 0.8 ? 1 : 0);
    let pl = { x: Math.random()*(W-80)+10, y: y, w: 75, h: 18, type: type, active: true, sp: 2, scored: false };
    if(type === 0) {
        if(Math.random() > 0.93) pl.spring = true;
        else if(Math.random() > 0.97) boosters.push({ x: pl.x+37, y: y-25 });
    }
    plats.push(pl);
    if(Math.random() > 0.97) enemies.push({ x: Math.random()*(W-40)+20, y: y-50, t: Math.random()*5, ang: 0, angVel: 0 });
}

function reset() {
    p.x = W/2; p.y = H-150; p.vx = 0; p.vy = 0; p.rocket = 0;
    score = 0; plats = []; enemies = []; bullets = []; boosters = []; particles = [];
    plats.push({x: W/2-50, y: H-50, w: 100, h:20, type: 0, active:true, scored: true});
    for(let i=1; i<12; i++) spawn(H - i*75);
}

function switchTrack(to) {
    if(!settings.music) return;
    if(to === 'game') { 
        audio.menu.pause(); 
        audio.game.currentTime = 0; 
        audio.game.play().catch(()=>{}); 
        document.getElementById('open-ui').style.display = 'flex'; // –û—Å—Ç–∞–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø–∞—É–∑–µ
        document.getElementById('open-leader').style.display = 'none'; // –õ–∏–¥–µ—Ä–±–æ—Ä–¥ —Å–∫—Ä—ã–≤–∞–µ–º –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
    }
    else if(to === 'menu') { 
        audio.game.pause(); 
        audio.menu.currentTime = 0; 
        audio.menu.play().catch(()=>{}); 
        document.getElementById('open-ui').style.display = 'flex';
        document.getElementById('open-leader').style.display = 'flex';
    }
    else { 
        audio.menu.pause(); 
        audio.game.pause(); 
        document.getElementById('open-ui').style.display = 'flex';
        document.getElementById('open-leader').style.display = 'flex';
    }
}

c.onpointerdown = e => {
    e.preventDefault();
    if(overlay.classList.contains('active')) return;
    const rect = c.getBoundingClientRect();
    input.startX = ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) / rect.width * W;
    input.currX = input.startX;
    const touchY = ((e.touches ? e.touches[0].clientY : e.clientY) - rect.top) / rect.height * H;
    c.setPointerCapture?.(e.pointerId);

    if(state === "MENU") {
        if(touchY > H * 0.75) {
            state = "PLAYING"; reset(); switchTrack('game');
            document.documentElement.requestFullscreen?.();
            document.getElementById('open-leader').style.display = 'none'; // –°–∫—Ä—ã—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥
        }
    } else if (state === "PLAYING") {
        if(!isPaused && p.rocket <= 0) bullets.push({ x: p.x, y: p.y - 40 });
    } else if (state === "GAMEOVER") {
        if(touchY > H/2 - 50 && touchY < H/2 + 50) { state = "PLAYING"; reset(); switchTrack('game'); }
        else if(touchY > H/2 + 60) { state = "MENU"; switchTrack('menu'); }
    }
};

window.onpointermove = e => {
    e.preventDefault();
    const rect = c.getBoundingClientRect();
    input.currX = ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) / rect.width * W;
};

window.onpointerup = e => {
    e.preventDefault();
    c.releasePointerCapture?.(e.pointerId);
    if(state === "MENU") {
        const dist = input.currX - input.startX;
        if(Math.abs(dist) > 60) {
            charIdx = (charIdx + (dist > 0 ? -1 : 1) + 4) % 4;
            if(settings.vibration) tg.HapticFeedback.selectionChanged();
        }
    }
};
window.onpointercancel = () => { input.currX = p.x; };

// Helper to draw image or fallback rect
function drawSafeImage(key, x, y, w, h, fallbackColor) {
    let img = imgs[key];
    if(img && img.complete && img.naturalWidth !== 0) {
        ctx.drawImage(img, x, y, w, h);
    } else {
        ctx.fillStyle = fallbackColor || "#f0f";
        ctx.fillRect(x, y, w, h);
    }
}

function loop() {
    requestAnimationFrame(loop);
    if(loadedCount < 8) {
         // Fallback: start anyway after timeout or checks, but here we wait
         // With our onError handler, loadedCount will increase anyway
    }

    // DRAW BACKGROUND
    drawSafeImage("bg.jpg", 0, 0, W, H, "#eee");

    // PAUSE LOGIC
    if(state === "PLAYING" && isPaused) {
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞—Å—Ç—ã–≤—à–µ–≥–æ –∫–∞–¥—Ä–∞ (–ø–µ—Ä—Å–æ–Ω–∞–∂, –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)
        drawGameObjects(); 
        // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.font = "bold 30px sans-serif";
        ctx.fillText("–ü–ê–£–ó–ê", W/2, H/2);
        return; // Skip physics
    }

    if(state === "PLAYING") {
        if(!tg.isExpanded) tg.expand();
        
        // PHYSICS
        let diff = 1 + (score / 3000);
        let speedKmh = 40 + (score / 70) * 0.25;
        let targetVX = (input.currX - p.x) * 0.2;
        p.vx += (targetVX - p.vx) * 0.25; p.x += p.vx;
        if(p.vx > 0.5) p.dir = 1; else if(p.vx < -0.5) p.dir = -1;
        if(p.x > W) p.x = 0; else if(p.x < 0) p.x = W;

        if(p.rocket > 0) { p.vy = rocketPower; p.rocket--; p.ang += 0.4; } 
        else { p.vy += gravity * diff; p.ang *= 0.92; p.ang += (p.vx * 0.04 - p.ang) * 0.12; }
        p.y += p.vy;

        let shift = 0; if(p.y < H * 0.45) { shift = H * 0.45 - p.y; p.y = H * 0.45; }

        plats.forEach(pl => {
            pl.y += shift;
            if(pl.type === 1) { pl.x += pl.sp; if(pl.x < 0 || pl.x > W-pl.w) pl.sp *= -1; }
            if(!pl.scored && p.y < pl.y) { score += 10; pl.scored = true; }
            if(p.vy > 0 && pl.active && p.x+20 > pl.x && p.x-20 < pl.x+pl.w && p.y+40 > pl.y && p.y+40 < pl.y+pl.h) {
                p.vy = pl.spring ? springPower : jumpPower;
                if(pl.type === 2) pl.active = false;
                if(settings.vibration) tg.HapticFeedback.impactOccurred('medium');
            }
        });

        boosters.forEach((b, i) => { b.y += shift; if(Math.hypot(p.x - b.x, p.y - b.y) < 35) { p.rocket = 70; boosters.splice(i, 1); }});
        bullets.forEach((b, i) => { b.y -= 14; if(b.y < -50) bullets.splice(i, 1); });
        enemies.forEach((e, i) => {
            e.y += shift; let drift = Math.sin(Date.now()*0.003 + e.t) * 45;
            e.angVel += (Math.random() - 0.5) * 0.02;
            e.angVel *= 0.95;
            e.ang += e.angVel;
            if(p.rocket <= 0 && Math.hypot(p.x - (e.x + drift), p.y - e.y) < 35) {
                state = "GAMEOVER";
                switchTrack('stop');
                if(settings.vibration) tg.HapticFeedback.impactOccurred('heavy');
            }
            bullets.forEach((bu, bi) => {
                if(Math.hypot(bu.x - (e.x + drift), bu.y - e.y) < 40) {
                    for(let j=0; j<12; j++) particles.push({ x: e.x + drift, y: e.y, vx: (Math.random()-0.5)*6, vy: (Math.random()-0.5)*6-2, life: 30 });
                    enemies.splice(i, 1); bullets.splice(bi, 1); score += 100;
                    if(settings.vibration) tg.HapticFeedback.impactOccurred('heavy');
                }
            });
        });

        if(score > high) { high = score; localStorage.setItem('biicla_high', high); }
        while(plats.length < 15) spawn(Math.min(...plats.map(o=>o.y)) - 80);
        plats = plats.filter(pl => pl.y < H + 100);
        if(p.y > H + 100) { 
            state = "GAMEOVER"; 
            switchTrack('stop'); 
        }

        drawGameObjects();

        // HUD
        ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillRect(0,0,W,50);
        ctx.strokeStyle = "#ff1a1a"; ctx.lineWidth = 2; ctx.strokeRect(2, 2, W-4, 46);
        ctx.fillStyle = "#ff1a1a"; ctx.font = "bold 20px sans-serif"; ctx.textAlign="left"; ctx.fillText("SCORE: " + score, 12, 30);
        ctx.textAlign="right"; ctx.fillText("HIGH: " + high, W-12, 30);
        ctx.font = "14px sans-serif"; ctx.fillStyle = "#fff"; ctx.textAlign="center"; ctx.fillText("SPEED: " + speedKmh.toFixed(1) + " –∫–º/—á", W/2, 35);
    } 
    else if(state === "MENU") {
        ctx.fillStyle = "rgba(0,0,0,0.4)"; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "#fff"; ctx.textAlign="center"; ctx.font="800 42px sans-serif"; ctx.fillText("OTSHITIE", W/2, 100);
        ctx.font="600 20px sans-serif"; ctx.fillText("JUMP", W/2, 130);
        ctx.font="14px sans-serif"; ctx.fillText("–°–≤–∞–π–ø –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞", W/2, 160);

        let img = imgs[files[charIdx]];
        if(img && img.complete && img.naturalWidth !== 0) {
            let cw = 80, ch = cw * (img.height/img.width);
            ctx.drawImage(img, W/2-cw/2, H/2-ch/2 + Math.sin(Date.now()*0.002)*15, cw, ch);
        } else {
            // Fallback char
             ctx.fillStyle = "cyan"; ctx.fillRect(W/2-40, H/2-40 + Math.sin(Date.now()*0.002)*15, 80, 80);
        }

        ctx.fillStyle = "#ff1a1a"; ctx.beginPath(); ctx.roundRect(W/2-100, H-120, 200, 60, 20); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.font="bold 22px sans-serif"; ctx.fillText("–ò–ì–†–ê–¢–¨", W/2, H-82);
    }
    else if(state === "GAMEOVER") {
        ctx.fillStyle = "rgba(0,0,0,0.85)"; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "#fff"; ctx.textAlign="center"; ctx.font = "bold 48px sans-serif"; ctx.fillText("FAIL", W/2, H/2 - 80);
        ctx.font = "24px sans-serif"; ctx.fillText("–°–ß–ï–¢: " + score, W/2, H/2 - 30);
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.roundRect(W/2-90, H/2+10, 180, 55, 15); ctx.fill();
        ctx.fillStyle = "#000"; ctx.font = "bold 20px sans-serif"; ctx.fillText("–ï–©–ï –†–ê–ó", W/2, H/2+45);
        ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.beginPath(); ctx.roundRect(W/2-90, H/2+75, 180, 50, 15); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.fillText("–í –ú–ï–ù–Æ", W/2, H/2+106);
    }
}

// –í—ã–Ω–µ—Å–µ–Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Ä–∏—Å–æ–≤–∞—Ç—å –∏ –Ω–∞ –ø–∞—É–∑–µ
function drawGameObjects() {
    plats.forEach(pl => {
        if(!pl.active) return;
        ctx.fillStyle = pl.type === 1 ? "#FFD700" : (pl.type === 2 ? "#ff1a1a" : "#fff");
        ctx.beginPath(); ctx.roundRect(pl.x, pl.y, pl.w, pl.h, 8); ctx.fill();
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2; ctx.stroke();
        if(pl.spring) { ctx.fillStyle="#000"; ctx.fillRect(pl.x+pl.w/2-8, pl.y-6, 16, 6); }
    });
    
    boosters.forEach(b => { 
        ctx.save(); ctx.translate(b.x, b.y); ctx.rotate(Math.sin(Date.now()*0.01)*0.2);
        drawSafeImage("burn.webp", -10, -10, 20, 20, "orange"); // approximate aspect
        ctx.restore();
    });
    
    enemies.forEach(e => { let d = Math.sin(Date.now()*0.003 + e.t)*45; 
        ctx.save();
        ctx.translate(e.x + d, e.y);
        ctx.rotate(e.ang);
        drawSafeImage("hot.webp", -17.5, -17.5, 35, 35, "red");
        ctx.restore();
    });
    
    bullets.forEach(b => {
        drawSafeImage("igla.webp", b.x-12.5, b.y-12.5, 25, 25, "yellow");
    });
    
    particles.forEach((pr, i) => {
        pr.x += pr.vx; pr.y += pr.vy; pr.vy += 0.2; pr.life--;
        ctx.fillStyle = `rgba(255, 100, 50, ${pr.life/30})`; 
        ctx.beginPath(); ctx.arc(pr.x, pr.y, 3, 0, Math.PI*2); ctx.fill();
        if(pr.life <= 0) particles.splice(i, 1);
    });
    
    let charImg = imgs[files[charIdx]];
    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.ang); if(p.dir === -1) ctx.scale(-1, 1);
    
    if(charImg && charImg.complete && charImg.naturalWidth !== 0) {
        let cw = 30, ch = cw * (charImg.height/charImg.width);
        ctx.drawImage(charImg, -cw/2, -ch/2, cw, ch); 
    } else {
        ctx.fillStyle = "#0f0"; ctx.fillRect(-15, -15, 30, 30); // fallback char
    }
    ctx.restore();
}

loop();
if(settings.music) audio.menu.play().catch(()=>{});
</script>
</body>
</html>
